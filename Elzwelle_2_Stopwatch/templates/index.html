<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Elzwelle Web View</title>
    <!-- Cosmo Theme passend zu ttkbootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/cosmo/bootstrap.min.css">
      
    <style>
    	.table-scroll-container {
		    /* Berechnet: 100% Fensterhöhe minus Platz für Header und Abstände */
		    height: calc(100vh - 200px) !important; 
		    overflow-y: scroll !important;
		    display: block;
		    border: 2px solid #888;
		}
		
		.table thead {
	    	position: sticky;
            top: 0;
            z-index: 1;
	    }
	    
	    .table {
	    	font-size: 1.3rem !important;
	    }
	    
	    .table thead th {
		    font-weight: bold;
		    background-color: #2780e3; 			/* Cosmo Blau */
        	color: white;
		}
		
    </style>
      
</head>
<body class="p-4">
    
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3 shadow-sm">
	    <div class="container-fluid d-flex justify-content-between align-items-center">
	        
	        <!-- Element 1: Titel/Branding (Links) -->
	        <div class="navbar-brand d-flex align-items-center">
	            <i class="bi bi-cpu me-2"></i> <!-- Optionales Icon -->
	            <h2><strong>Elzwelle Live Monitor</strong></h2>
	        </div>
	
	        <!-- Element 2: Server-Zeit (Mitte) -->
	        <div class="text-white text-center">
	            <span class="h3 opacity-75">Serverzeit:</span>
	            <span id="server-time" class="h3 mb-0 ms-2 font-monospace">--:--:--</span>
	        </div>
	
	        <!-- Element 3: Status / Threads (Rechts) -->
	        <div id="status-indicators" class="d-flex gap-3">
	            <span class="badge rounded-pill bg-success border border-light">MQTT OK</span>
	            <span class="badge rounded-pill bg-success border border-light">Serial OK</span>
	        </div>
	
	    </div>
	</nav>
	
	<div class="row">
		<!-- Linke Spalte: Start -->
		<div class="col-md-6">
			<div class="h2 border bg-success text-light text-center"><strong>Start</strong></div>
		   	<div class="table-scroll-container">
		        <table class="table table-striped mb-0">
					<thead>
					    <tr>
					    	<th>Zeit</th>
					    	<th>Zeitstempel</th>
					    </tr>
					</thead>
		            <tbody id="table-start">
		                <!-- Daten kommen via JS -->
		            </tbody>
		        </table>
		    </div>
		</div>
	    <!-- Rechte Spalte: Ziel -->
	    <div class="col-md-6">
	    	<div class="h2 border bg-danger text-light text-center"><strong>Ziel</strong></div>
			<div class="table-scroll-container">
			    <table class="table table-striped mb-0">
			        <thead>
			            <tr>
			            	<th>Zeit</th>
			            	<th>Zeitstempel</th>
			            </tr>
			        </thead>
			        <tbody id="table-finish">
			            <!-- Daten kommen via JS -->
			        </tbody>
			    </table>
			</div>       
	    </div>
	</div>
    

    <script>
        async function refreshData() {
            try {
                const response = await fetch('/api/data');
                // const data = await response.json();
                
                const root = await response.json(); // Das gesamte Objekt holen

		        // 1. Die Server-Zeit oben in der GUI anzeigen
		        const words = root.now.trim().split(/\s+/);
		        document.getElementById('server-time').innerText = words[2]+" "+words[4];
		
		        // 2. Die eigentlichen Daten für die Filterung nehmen
		        const data = root.data; 
                
                // Filtern für Start
                const startRows = data.filter(item => item.src === 'Start').reverse();
                document.getElementById('table-start').innerHTML = startRows.map(item => `
                    <tr>
                        <td>${item.time || '-'}</td>
                        <td>${item.val}</td>
                    </tr>
                `).join('');

                // Filtern für Ziel
                const finishRows = data.filter(item => item.src === 'Finish').reverse();
                document.getElementById('table-finish').innerHTML = finishRows.map(item => `
                    <tr>
                        <td>${item.time || '-'}</td>
                        <td>${item.val}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error("Daten konnten nicht geladen werden:", err);
            }
        }

        // Alle 1000ms aktualisieren
        setInterval(refreshData, 1000);
		
    </script>
</body>
</html>
